<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Geospatial Assistance System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --primary-bg:#0f172a;
  --card-bg:#1e293b;
  --accent-blue:#38bdf8;
  --accent-green:#22c55e;
  --accent-red:#ef4444;
  --text-main:#f8fafc;
  --text-dim:#94a3b8;
}
body{
  margin:0;
  background:var(--primary-bg);
  color:var(--text-main);
  font-family:'Segoe UI',Tahoma;
  padding:20px;
}
.header{text-align:center;margin-bottom:24px}
.header h1{margin:0;color:var(--accent-blue)}
.header p{color:var(--text-dim);margin-top:6px}

.mode-selector{
  display:flex;justify-content:center;gap:10px;
  background:var(--card-bg);padding:8px;
  border-radius:40px;max-width:320px;margin:0 auto 30px;
}
.mode-btn{
  border:none;padding:10px 22px;border-radius:30px;
  background:transparent;color:var(--text-dim);
  cursor:pointer;font-weight:bold;
}
.mode-btn.active{background:var(--accent-blue);color:#fff}

.main-layout{
  display:grid;
  grid-template-columns:1fr 1.3fr;
  gap:24px;
  max-width:1200px;
  margin:auto;
}

.panel{
  background:var(--card-bg);
  border-radius:18px;
  padding:20px;
  border:1px solid rgba(255,255,255,.08);
  position:relative;
}

#voice-section{
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:220px;
}
.circle-btn{
  width:160px;height:160px;border-radius:50%;
  border:none;background:var(--accent-blue);
  color:#fff;font-size:1.1rem;cursor:pointer;
}

#text-section{display:none}
#text-input{
  width:100%;padding:12px;border-radius:12px;border:none;
  margin-bottom:10px;
}
#send-text-btn{
  width:100%;padding:10px;border-radius:10px;
  border:none;background:var(--accent-blue);
  color:#fff;font-weight:bold;cursor:pointer;
}

/* Map */
#map{height:500px;border-radius:16px}
.map-input{
  position:absolute;top:14px;left:14px;
  background:#020617cc;padding:8px;
  border-radius:10px;z-index:999;
}
.map-input input{width:80px}
.map-input button{
  background:var(--accent-blue);
  border:none;border-radius:8px;
  color:#fff;padding:6px 10px;
  cursor:pointer;
}

.legend{margin-top:10px;color:var(--text-dim);font-size:.85rem}

/* Results */
.results{max-width:1200px;margin:30px auto 100px}
.chat-card{
  background:var(--card-bg);
  border-radius:16px;
  padding:18px;
  border-right:5px solid var(--accent-blue);
}

/* Bottom alert */
#gps-alert-bar{
  position:fixed;bottom:0;left:0;
  width:100%;padding:14px;
  text-align:center;
  background:#334155;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="header">
  <h1>Geospatial Assistance System</h1>
  <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø©</p>
</div>

<div class="mode-selector">
  <button class="mode-btn active" id="voiceBtn" onclick="switchMode('voice')">ğŸ¤ Ø§Ù„ØªØ­Ø¯Ø«</button>
  <button class="mode-btn" id="textBtn" onclick="switchMode('text')">âŒ¨ï¸ Ø§Ù„ÙƒØªØ§Ø¨Ø©</button>
</div>

<div class="main-layout">

  <!-- Interaction -->
  <div class="panel">
    <h3>Ø§Ø³Ø£Ù„Ù†ÙŠ</h3>

    <div id="voice-section">
      <button class="circle-btn">ğŸ¤<br>ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†</button>
    </div>

    <div id="text-section">
      <input id="text-input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§...">
      <button id="send-text-btn">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>

  <!-- Map -->
  <div class="panel">
    <h3>Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h3>

    <div class="map-input">
      <input id="lat" placeholder="Lat">
      <input id="lng" placeholder="Lng">
      <button onclick="addPoint()">Ø¥Ø¶Ø§ÙØ©</button>
    </div>

    <div id="map"></div>

    <div class="legend">
      ğŸ”µ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ<br>
      ğŸŸ¢ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­Ù…ÙŠØ© â€” ğŸ”´ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­Ù…ÙŠØ©
    </div>
  </div>
</div>

<div class="results">
  <div class="chat-card">
    <div id="bot-p">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….</div>
  </div>
</div>

<div id="gps-alert-bar">
  Ø¬Ø§Ù‡Ø²â€¦
</div>

<audio id="alarm" src="/gps_alert.mp3" preload="auto"></audio>

<script>
/* ===== Mode switch ===== */
function switchMode(mode){
  const v=document.getElementById("voice-section");
  const t=document.getElementById("text-section");
  voiceBtn.classList.toggle("active",mode==="voice");
  textBtn.classList.toggle("active",mode==="text");
  v.style.display=mode==="voice"?"flex":"none";
  t.style.display=mode==="text"?"block":"none";
}

/* ===== Map ===== */
const map=L.map("map").setView([24.7136,46.6753],9);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const zones=L.geoJSON(null,{style:{color:"#38bdf8",weight:2,fillOpacity:.12}}).addTo(map);
const points=L.geoJSON(null,{
  pointToLayer:(f,ll)=>L.circleMarker(ll,{
    radius:6,
    color:f.properties.inside_geofence?"#22c55e":"#ef4444",
    fillColor:f.properties.inside_geofence?"#22c55e":"#ef4444",
    fillOpacity:1
  })
}).addTo(map);

async function loadMap(){
  const r=await fetch("/llm/map-data");
  const d=await r.json();
  zones.clearLayers();
  points.clearLayers();
  zones.addData(d.zones);
  points.addData(d.points);
}
loadMap();
setInterval(loadMap,5000);

/* User location */
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(p=>{
    L.circleMarker([p.coords.latitude,p.coords.longitude],{
      radius:8,color:"#0ea5e9",fillColor:"#0ea5e9",fillOpacity:1
    }).addTo(map);
  });
}

/* ===== Add point (FIXED) ===== */
async function addPoint(){

  const latInput = document.getElementById("lat");
  const lngInput = document.getElementById("lng");

  const lat = parseFloat(latInput.value);
  const lng = parseFloat(lngInput.value);

  if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
    alert("Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
    return;
  }

  const response = await fetch("/llm/add-point",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ lat, lng })
  });

  const d = await response.json();

  const bar = document.getElementById("gps-alert-bar");
  const alarm = document.getElementById("alarm");

  if (d.inside === true) {
    bar.style.background = "#166534";
    bar.innerText = "ğŸŸ¢ Ø¯Ø§Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø­Ù…ÙŠØ©";
    alarm.pause();
    alarm.currentTime = 0;
  } else {
    bar.style.background = "#7f1d1d";
    bar.innerText = "ğŸ”´ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø­Ù…ÙŠØ©";
    alarm.currentTime = 0;
    alarm.play();
  }

  latInput.value="";
  lngInput.value="";
  loadMap();
}
</script>

</body>
</html>
