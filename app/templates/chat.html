<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Geospatial Assistance System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --primary-bg:#0f172a;
  --card-bg:#1e293b;
  --accent-blue:#38bdf8;
  --accent-green:#22c55e;
  --accent-red:#ef4444;
  --text-main:#f8fafc;
  --text-dim:#94a3b8;
}

body{
  margin:0;
  background:var(--primary-bg);
  color:var(--text-main);
  font-family:'Segoe UI',Tahoma;
  padding:20px;
  padding-bottom:90px;
}

.header{text-align:center;margin-bottom:20px}
.header h1{margin:0;color:var(--accent-blue)}
.header p{color:var(--text-dim)}

.mode-selector{
  display:flex;justify-content:center;gap:10px;
  background:var(--card-bg);padding:8px;
  border-radius:40px;max-width:320px;margin:0 auto 20px;
}
.mode-btn{
  border:none;padding:10px 22px;border-radius:30px;
  background:transparent;color:var(--text-dim);
  cursor:pointer;font-weight:bold;
}
.mode-btn.active{background:var(--accent-blue);color:#fff}

.main-layout{
  display:grid;
  grid-template-columns:1fr 1.3fr;
  gap:20px;
  max-width:1200px;
  margin:auto;
}

.panel{
  background:var(--card-bg);
  border-radius:18px;
  padding:20px;
  border:1px solid rgba(255,255,255,.08);
  position:relative;
}

/* Interaction */
#voice-section{
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:200px;
}
.circle-btn{
  width:160px;height:160px;border-radius:50%;
  border:none;background:var(--accent-blue);
  color:#fff;font-size:1.1rem;cursor:pointer;
}

#text-section{display:none}
#text-input{
  width:100%;padding:12px;border-radius:12px;border:none;
  margin-bottom:10px;
}
#send-text-btn{
  width:100%;padding:10px;border-radius:10px;
  border:none;background:var(--accent-blue);
  color:#fff;font-weight:bold;cursor:pointer;
}

/* Map */
#map{height:480px;border-radius:16px}

.map-input{
  position:absolute;top:12px;left:12px;
  background:#020617cc;padding:8px;
  border-radius:10px;z-index:1000;
}
.map-input input{
  width:80px;
  margin-bottom:4px;
}
.map-input button{
  width:100%;
  background:var(--accent-blue);
  border:none;border-radius:8px;
  color:#fff;padding:6px;
  cursor:pointer;
}

.legend{margin-top:8px;color:var(--text-dim);font-size:.85rem}

/* Chat */
.results{max-width:1200px;margin:20px auto}
.chat-card{
  background:var(--card-bg);
  border-radius:16px;
  padding:16px;
  border-right:5px solid var(--accent-blue);
}

/* Bottom Alert */
#gps-alert-bar{
  position:fixed;
  bottom:0;left:0;
  width:100%;
  height:60px;
  line-height:60px;
  text-align:center;
  background:#334155;
  font-weight:bold;
  z-index:9999;
}
</style>
</head>

<body>

<div class="header">
  <h1>Geospatial Assistance System</h1>
  <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø£Ùˆ Ø£Ø¶Ù Ù†Ù‚Ø·Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</p>
</div>

<div class="mode-selector">
  <button class="mode-btn active" id="voiceBtn">ğŸ¤ Ø§Ù„ØªØ­Ø¯Ø«</button>
  <button class="mode-btn" id="textBtn">âŒ¨ï¸ Ø§Ù„ÙƒØªØ§Ø¨Ø©</button>
</div>

<div class="main-layout">

  <!-- Interaction -->
  <div class="panel">
    <h3>Ø§Ø³Ø£Ù„Ù†ÙŠ</h3>

    <div id="voice-section">
      <button class="circle-btn" id="micBtn">ğŸ¤<br>ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†</button>
    </div>

    <div id="text-section">
      <input id="text-input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§...">
      <button id="send-text-btn">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>

  <!-- Map -->
  <div class="panel">
    <h3>Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h3>

    <div class="map-input">
      <input id="lng" placeholder="Lng">
      <input id="lat" placeholder="Lat">
      <button id="addPointBtn">Ø¥Ø¶Ø§ÙØ©</button>
    </div>

    <div id="map"></div>

    <div class="legend">
      ğŸŸ¢ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­Ù…ÙŠØ© â€” ğŸ”´ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­Ù…ÙŠØ©
    </div>
  </div>
</div>

<div class="results">
  <div class="chat-card">
    <div id="bot-p">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….</div>
  </div>
</div>

<div id="gps-alert-bar">Ø¬Ø§Ù‡Ø²â€¦</div>
<audio id="alarm" src="/gps_alert.mp3" preload="auto"></audio>

<script>
/* ===== MODE SWITCH ===== */
const voiceBtn = document.getElementById("voiceBtn");
const textBtn  = document.getElementById("textBtn");
const voiceSec = document.getElementById("voice-section");
const textSec  = document.getElementById("text-section");

voiceBtn.onclick = ()=>switchMode("voice");
textBtn.onclick  = ()=>switchMode("text");

function switchMode(mode){
  voiceBtn.classList.toggle("active",mode==="voice");
  textBtn.classList.toggle("active",mode==="text");
  voiceSec.style.display = mode==="voice"?"flex":"none";
  textSec.style.display  = mode==="text"?"block":"none";
}

/* ===== MAP ===== */
const map = L.map("map").setView([25.13,46.57],9);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const zones = L.geoJSON(null).addTo(map);

const points = L.geoJSON(null,{
  pointToLayer:(f,ll)=>{
    const v = f.properties?.visual || {};
    return L.circleMarker(ll,{
      radius: v.radius || 6,
      color: v.color || "#ef4444",
      fillColor: v.color || "#ef4444",
      fillOpacity:1
    }).bindPopup(v.popup || "");
  }
}).addTo(map);

async function loadMap(){
  const r = await fetch("/llm/map-data");
  const d = await r.json();
  zones.clearLayers();
  points.clearLayers();
  zones.addData(d.zones);
  points.addData(d.points);
}

loadMap();
setInterval(loadMap,3000);

/* ===== ADD POINT ===== */
document.getElementById("addPointBtn").addEventListener("click", async ()=>{
  const lat = parseFloat(document.getElementById("lat").value);
  const lng = parseFloat(document.getElementById("lng").value);

  if(!Number.isFinite(lat)||!Number.isFinite(lng)){
    alert("Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
    return;
  }

  const r = await fetch("/llm/add-point",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({lat,lng})
  });

  const d = await r.json();
  const bar = document.getElementById("gps-alert-bar");

  if(d.inside){
    bar.style.background="#166534";
    bar.innerText =
      `ğŸŸ¢ Ø¯Ø§Ø®Ù„ ${d.zone_name} â€” Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ù…Ø§ÙŠØ©: ${(d.protection_level||"").toUpperCase()}`;
  }else{
    bar.style.background="#7f1d1d";
    bar.innerText="ğŸ”´ Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø­Ù…ÙŠØ©";
    document.getElementById("alarm").play();
  }

  loadMap();
});

/* ===== CHAT EVENTS ===== */
document.getElementById("send-text-btn").onclick = ()=>{
  const text = document.getElementById("text-input").value.trim();
  if(!text) return;
  document.getElementById("bot-p").innerText="ğŸ¤– ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø³Ø¤Ø§Ù„Ùƒâ€¦";
};

document.getElementById("micBtn").onclick = ()=>{
  document.getElementById("bot-p").innerText="ğŸ™ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...";
};
</script>

</body>
</html>
