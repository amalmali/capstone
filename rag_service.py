from services.retriever_service import retrievers
from services.llm_service import generate
import re

# الـ Prompt المطور بنظام "الحدود المغلقة" لضمان الدقة القانونية
PROMPT_TEMPLATE ={
    "protected_areas_rules": """أنت خبير قانوني مختص بمخالفات المحميات الطبيعية.

أجب اعتمادًا حصريًا على النص الوارد في السياق أدناه.

قواعد إلزامية:
- لا تستخدم أي معرفة خارج النص.
- لا تدمج بين مستويات حماية مختلفة.
- لا تغيّر صياغة الغرامات أو قيمها.
- إذا لم تجد الغرامة أو المخالفة نصًا، أجب:
"عذراً، هذه المعلومة غير منصوص عليها في المرجع."

ابدأ الإجابة دائمًا بـ:
"وفقًا للمرجع الموحد لمخالفات المحميات الطبيعية،"

السياق:
{context}

السؤال:
{question}

الإجابة:
""",

    "مشروع_اللائحة_التنفيذية_للمناطق_المحمية": """أنت مساعد ذكي يعمل بنظام الاسترجاع المعزز (RAG) لتقديم معلومات عامة عن المحميات الطبيعية.

اعتمد بشكل أساسي على النص المسترجع في السياق، 
ويُسمح لك باستخدام معرفتك العامة استخدامًا محدودًا فقط من أجل:
- تبسيط المعلومة
- إعادة صياغتها بشكل أوضح
- ربط الجملة لغويًا

قواعد مهمة:
1. لا تضف حقائق جديدة غير موجودة في السياق.
2. لا تذكر أرقامًا أو تفاصيل رسمية غير مذكورة.
3. لا تذكر قوانين أو غرامات أو عقوبات.
4. لا تقدّم استنتاجات علمية أو تقييمات بيئية.
5. إذا لم يتوفر جواب واضح في السياق، قل:
   "لا تتوفر معلومات كافية حول ذلك في الدليل المتاح."

أسلوب الإجابة:
- لغة عربية بسيطة.
- شرح مختصر وواضح.
- يمكن استخدام جملة تمهيدية عامة فقط دون إضافة معلومات جديدة.

السياق:
{context}

السؤال:
{question}

الإجابة:
"""
}


def answer(query: str, pdf_name: str):
    # 1. التحقق من تحميل قاعدة البيانات الخاصة بالملف
    retriever = retrievers.get(pdf_name)
    if not retriever:
        return "عذراً، محرك البحث القانوني غير جاهز حالياً. يرجى الانتظار لحظات.", ""

    # 2. استرجاع النصوص ذات الصلة (Context)
  
    docs = retriever.invoke(query)
    
    formatted_contexts = []
    for i, doc in enumerate(docs):
        # تنظيف متقدم للنص (Regex) لضمان جودة استخراج الجداول:
        # - إزالة المسافات الزائدة والرموز الغريبة التي تنتج عن تحويل الـ PDF العربي
        text = doc.page_content
        text = re.sub(r'\s+', ' ', text)  # توحيد المسافات
        text = re.sub(r'[^\w\s\.\-\(\)%٠-٩,،:]', '', text) # تنظيف مع الحفاظ على الأرقام العربية وعلامات الترقيم الأساسية
        clean_content = text.strip()
        
        # إضافة إشارة لمصدر القطعة النصية لتنظيم ذهن الموديل
        formatted_contexts.append(f"--- [الفقرة/المادة رقم {i+1}] ---\n{clean_content}")
    
    context = "\n\n".join(formatted_contexts)

    # 3. حماية في حال فشل الاسترجاع أو عدم وجود نتائج مطابقة
    if not context.strip():
        return "عذراً، لم أجد نصوصاً في اللائحة الحالية تتعلق بهذا الاستفسار.", ""

    # 4. بناء الـ Prompt ودمج السؤال مع السياق
    prompt_template = PROMPTS.get(pdf_name)
    if not prompt_template:
     return "لا يوجد برومبت مخصص لهذا المستند.", context

    final_prompt = prompt_template.format(
    context=context,
    question=query
   )


    # 5. طلب الإجابة من الموديل (Qwen 2.5 1.5B)
    response = generate(final_prompt)
    
    # 6. معالجة الرد (Post-processing) لمنع الاستنتاجات الشخصية للموديل
    # إذا بدأ الموديل بكلمات تدل على التخمين، يتم حجب الإجابة لضمان الدقة
    forbidden_indicators = [
        "بناءً على فهمي", "ربما", "أعتقد", "بشكل عام", 
        "من المحتمل", "على الأرجح", "قد يكون"
    ]
    
    check_response = response.strip()
    if any(check_response.startswith(phrase) for phrase in forbidden_indicators):
        return "عذراً، التفاصيل الدقيقة لهذا السؤال غير منصوص عليها بوضوح في اللائحة المرفقة.", context

    return response.strip(), context