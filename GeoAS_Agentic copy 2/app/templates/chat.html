<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Geospatial Assistance System</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --primary-bg:#0f172a;
  --card-bg:#1e293b;
  --accent-blue:#38bdf8;
  --accent-green:#22c55e;
  --accent-red:#ef4444;
  --accent-amber:#f59e0b;
  --text-main:#f8fafc;
  --text-dim:#94a3b8;
  --border: rgba(255,255,255,.08);
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--primary-bg);
  color:var(--text-main);
  font-family:'Segoe UI',Tahoma,Arial,sans-serif;
  padding:20px;
  padding-bottom:90px; /* ÙŠÙ…Ù†Ø¹ ØªØ¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
}
.header{text-align:center;margin-bottom:18px}
.header h1{margin:0;color:var(--accent-blue);font-size:1.4rem}
.header p{margin:6px 0 0;color:var(--text-dim)}

.mode-selector{
  display:flex;
  justify-content:center;
  gap:10px;
  background:var(--card-bg);
  padding:8px;
  border-radius:40px;
  max-width:360px;
  margin:0 auto 18px;
  border:1px solid var(--border);
}
.mode-btn{
  border:none;
  padding:10px 22px;
  border-radius:30px;
  background:transparent;
  color:var(--text-dim);
  cursor:pointer;
  font-weight:700;
  transition:.15s ease;
}
.mode-btn.active{background:var(--accent-blue);color:#fff}

.main-layout{
  display:grid;
  grid-template-columns:1fr 1.35fr;
  gap:18px;
  max-width:1200px;
  margin:auto;
}
.panel{
  background:var(--card-bg);
  border-radius:18px;
  padding:18px;
  border:1px solid var(--border);
  position:relative;
  min-width:0;
}
.panel h3{margin:0 0 10px}

.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.spacer{height:10px}
hr{border:none;border-top:1px solid rgba(255,255,255,.08);margin:12px 0}

/* ===== Input / buttons ===== */
input, textarea{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  outline:none;
  background:#0b1224;
  color:var(--text-main);
}
input::placeholder{color:#7c8aa5}
.btn{
  border:none;
  background:var(--accent-blue);
  color:#fff;
  font-weight:800;
  padding:10px 14px;
  border-radius:12px;
  cursor:pointer;
  transition:.12s ease;
  user-select:none;
}
.btn:disabled{opacity:.55;cursor:not-allowed}
.btn.secondary{
  background:#0b1224;
  border:1px solid rgba(255,255,255,.12);
  color:var(--text-main);
}
.btn.danger{background:var(--accent-red)}
.btn.green{background:var(--accent-green)}
.btn.amber{background:var(--accent-amber)}

/* ===== Voice mode button ===== */
.circle-btn{
  width:170px;height:170px;border-radius:50%;
  display:flex;flex-direction:column;justify-content:center;align-items:center;
  border:none;background:var(--accent-blue);
  color:#fff;font-size:1.05rem;cursor:pointer;font-weight:800;
}
.circle-btn:disabled{opacity:.6;cursor:not-allowed}

/* ===== Sections ===== */
#voice-section{display:flex;justify-content:center;align-items:center;min-height:220px}
#text-section{display:none}

/* ===== Map ===== */
#map{height:500px;border-radius:16px}
.map-input{
  position:absolute;top:14px;left:14px;
  background:#020617cc;
  padding:10px;
  border-radius:12px;
  z-index:1000;
  border:1px solid rgba(255,255,255,.10);
  backdrop-filter: blur(6px);
}
.map-input input{
  width:110px;
  padding:8px 10px;
  border-radius:10px;
  margin-bottom:6px;
}
.map-input .btn{width:100%;padding:8px;border-radius:10px}

.legend{margin-top:10px;color:var(--text-dim);font-size:.9rem;line-height:1.45}
.small{color:var(--text-dim);font-size:.9rem}

/* ===== Chat ===== */
.results{max-width:1200px;margin:18px auto}
.chat-card{
  background:rgba(15,23,42,.35);
  border:1px solid rgba(255,255,255,.08);
  border-radius:16px;
  padding:14px;
}
.chat-line{margin:0;line-height:1.6}
.chat-line strong{color:var(--accent-blue)}
.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  font-size:.85rem;
  border:1px solid rgba(255,255,255,.12);
  color:var(--text-dim);
  margin-inline-start:6px;
}

/* ===== Bottom alert ===== */
#gps-alert-bar{
  position:fixed;bottom:0;left:0;
  width:100%;height:60px;line-height:60px;
  text-align:center;
  background:#334155;
  font-weight:900;
  z-index:9999;
  padding:0 10px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* responsive */
@media (max-width: 980px){
  .main-layout{grid-template-columns:1fr}
  #map{height:420px}
  .map-input input{width:120px}
}
</style>
</head>

<body>

<div class="header">
  <h1>Geospatial Assistance System</h1>
  <p>Ø§Ø³Ø£Ù„ÙŠ ÙƒØªØ§Ø¨Ø© Ø£Ùˆ ØµÙˆØªØŒ ÙˆØ§Ù„Ø±Ø¯ ÙŠØ±Ø¬Ø¹ ØµÙˆØªÙŠÙ‹Ø§ + Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø­Ù…ÙŠØ§Øª</p>
</div>

<div class="mode-selector">
  <button class="mode-btn active" id="voiceBtn" type="button">ğŸ¤ Ø§Ù„ØªØ­Ø¯Ø«</button>
  <button class="mode-btn" id="textBtn" type="button">âŒ¨ï¸ Ø§Ù„ÙƒØªØ§Ø¨Ø©</button>
</div>

<div class="main-layout">

  <!-- ===== Interaction ===== -->
  <div class="panel">
    <h3>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</h3>

    <div class="small" id="hint">
      Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø±Ø¯ Ø§Ù„ØµÙˆØªÙŠ ÙŠØªÙ… Ø¹Ø¨Ø± Ø§Ù„Ù…ØªØµÙØ­ (Ù‚Ø¯ ØªØ­ØªØ§Ø¬ÙŠ Ø£ÙˆÙ„ Ù…Ø±Ø© ØªØ¶ØºØ·ÙŠ Ø²Ø± â€œØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØªâ€).
    </div>

    <div class="spacer"></div>

    <!-- Voice -->
    <div id="voice-section">
      <button class="circle-btn" id="micBtn" type="button">ğŸ¤<div style="font-size:.9rem;margin-top:6px">ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†</div></button>
    </div>

    <!-- Text -->
    <div id="text-section">
      <input id="text-input" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." />

      <!-- ===== VLM Image Upload (ØªØ­Øª ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙƒØªØ§Ø¨Ø©) ===== -->
      <div class="row">
        <input type="file" id="image-input" accept="image/*">
        <button class="btn amber" id="upload-image-btn" type="button">ğŸ“· ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</button>
      </div>

    <div class="row">
      <button class="btn" id="send-text-btn" type="button">Ø¥Ø±Ø³Ø§Ù„</button>
      <button class="btn secondary" id="enable-tts-btn" type="button">ğŸ”Š ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª</button>
      <button class="btn secondary" id="stop-tts-btn" type="button">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª</button>
    </div>
</div>


    <hr />

    <!-- Output -->
    <div class="chat-card">
      <p class="chat-line"><strong>Ø§Ù„Ø±Ø¯:</strong> <span id="bot-p">Ø¬Ø§Ù‡Ø²Ø© ğŸ‘‹</span></p>
      <p class="chat-line small" id="status-p"></p>
    </div>

    <div class="spacer"></div>

    <!-- TTS controls also in voice mode -->
    <div class="row">
      <button class="btn secondary" id="enable-tts-btn-2" type="button">ğŸ”Š ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª</button>
      <button class="btn secondary" id="stop-tts-btn-2" type="button">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª</button>
      <span class="badge" id="tts-badge">TTS: ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„</span>
    </div>

  </div>

  <!-- ===== Map ===== -->
  <div class="panel">
    <h3>Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h3>

    <div class="map-input">
      <input id="lng" placeholder="Lng" inputmode="decimal">
      <input id="lat" placeholder="Lat" inputmode="decimal">
      <button class="btn" id="addPointBtn" type="button">Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø©</button>
    </div>

    <div id="map"></div>

    <div class="legend">
      ğŸ”µ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¥Ù† ÙˆÙØ¬Ø¯)<br>
      ğŸŸ¢ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­Ù…ÙŠØ© â€” ğŸ”´ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­Ù…ÙŠØ©<br>
      Ø§Ø¶ØºØ·ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø·Ø© Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± Popup
    </div>
  </div>
</div>

<div class="results">
  <div class="chat-card">
    <p class="chat-line small">
      Ù†ØµÙŠØ­Ø©: Ø¥Ø°Ø§ Ù…Ø§ Ù†Ø·Ù‚ Ø§Ù„ØµÙˆØª Ø£ÙˆÙ„ Ù…Ø±Ø©ØŒ Ø§Ø¶ØºØ·ÙŠ <b>ğŸ”Š ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª</b> Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©.
    </p>
  </div>
</div>

<div id="gps-alert-bar">Ø¬Ø§Ù‡Ø²â€¦</div>

<script>
/* ================= Helpers ================= */
const $ = (id)=>document.getElementById(id);
function setStatus(msg){ $("status-p").innerText = msg || ""; }
function setBot(msg){ $("bot-p").innerText = msg || ""; }

/* ================= Mode switch ================= */
const voiceBtn = $("voiceBtn");
const textBtn  = $("textBtn");
const voiceSec = $("voice-section");
const textSec  = $("text-section");

voiceBtn.addEventListener("click", ()=>switchMode("voice"));
textBtn.addEventListener("click",  ()=>switchMode("text"));

function switchMode(mode){
  voiceBtn.classList.toggle("active", mode==="voice");
  textBtn.classList.toggle("active",  mode==="text");
  voiceSec.style.display = (mode==="voice") ? "flex" : "none";
  textSec.style.display  = (mode==="text")  ? "block" : "none";
}

/* ================= Browser TTS ================= */
let ttsEnabled = false;

function updateTtsBadge(){
  $("tts-badge").innerText = `TTS: ${ttsEnabled ? "Ù…ÙØ¹Ù‘Ù„" : "ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„"}`;
  $("tts-badge").style.color = ttsEnabled ? "#bbf7d0" : "#94a3b8";
}

function stopSpeech(){
  try{ window.speechSynthesis.cancel(); }catch(e){}
}

function speak(text){
  if(!ttsEnabled) return;
  if(!text) return;
  stopSpeech();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "ar-SA";
  u.rate = 1.0;
  u.pitch = 1.0;
  window.speechSynthesis.speak(u);
}

function enableTts(){
  // Ù„Ø§Ø²Ù… â€œgestureâ€ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø´Ø§Ù† Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ³Ù…Ø­
  ttsEnabled = true;
  updateTtsBadge();
  setStatus("âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ø§Ù„Ù…ØªØµÙØ­");
  // Ù†Ø·Ù‚ Ø¨Ø³ÙŠØ· Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„
  speak("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª");
}

$("enable-tts-btn")?.addEventListener("click", enableTts);
$("enable-tts-btn-2")?.addEventListener("click", enableTts);

$("stop-tts-btn")?.addEventListener("click", ()=>{ stopSpeech(); setStatus("â¹ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª"); });
$("stop-tts-btn-2")?.addEventListener("click", ()=>{ stopSpeech(); setStatus("â¹ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª"); });

updateTtsBadge();

/* ================= MAP (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø§Ùƒ-Ø¥Ù†Ø¯) ================= */
const map = L.map("map").setView([25.13,46.57],9);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const zones = L.geoJSON(null,{
  style: (f)=>({
    color:
      f.properties?.protection_level === "high" ? "#ef4444" :
      f.properties?.protection_level === "medium" ? "#f59e0b" :
      "#38bdf8",
    weight: 2,
    fillOpacity: 0.15
  })
}).addTo(map);

const points = L.geoJSON(null,{
  pointToLayer:(f,ll)=>{
    const v = f.properties?.visual || {};
    const color = v.color || "#ef4444";
    const radius = v.radius || 6;
    const popup = v.popup || "";
    return L.circleMarker(ll,{
      radius, color, fillColor: color, fillOpacity: 1
    }).bindPopup(popup);
  }
}).addTo(map);

async function loadMap(){
  const r = await fetch("/llm/map-data");
  if(!r.ok) throw new Error(`map-data HTTP ${r.status}`);
  const d = await r.json();
  zones.clearLayers();
  points.clearLayers();
  zones.addData(d.zones);
  points.addData(d.points);
}

async function safeLoadMap(){
  try{
    await loadMap();
  }catch(err){
    console.error(err);
    setStatus("âš ï¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø©. ØªØ£ÙƒØ¯ÙŠ Ø£Ù† /llm/map-data Ø´ØºØ§Ù„.");
  }
}

safeLoadMap();
setInterval(safeLoadMap, 5000);

/* User location marker (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) */
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(p=>{
    L.circleMarker([p.coords.latitude,p.coords.longitude],{
      radius:8,color:"#0ea5e9",fillColor:"#0ea5e9",fillOpacity:1
    }).addTo(map);
  });
}

/* ================= Add point ================= */
const addPointBtn = $("addPointBtn");
addPointBtn.addEventListener("click", async ()=>{
  const lat = parseFloat($("lat").value);
  const lng = parseFloat($("lng").value);

  if(!Number.isFinite(lat) || !Number.isFinite(lng)){
    alert("Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
    return;
  }

  addPointBtn.disabled = true;
  setStatus("ğŸ“ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù†Ù‚Ø·Ø©â€¦");

  try{
    const r = await fetch("/llm/add-point",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ lat, lng })
    });

    if(!r.ok) throw new Error(`add-point HTTP ${r.status}`);
    const d = await r.json();

    const bar = $("gps-alert-bar");
    if(d.inside){
      bar.style.background = "#166534";
      bar.innerText = `ğŸŸ¢ Ø¯Ø§Ø®Ù„ ${d.zone_name || "Ù…Ø­Ù…ÙŠØ©"} â€” Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ù…Ø§ÙŠØ©: ${d.protection_level || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}`;
    }else{
      bar.style.background = "#7f1d1d";
      bar.innerText = "ğŸ”´ Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ù…Ø­Ù…ÙŠ";
    }

    // Ù†Ø¸Ù‘ÙÙŠ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    $("lat").value = "";
    $("lng").value = "";

  }catch(err){
    console.error(err);
    setStatus("âŒ ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø·Ø©. Ø´ÙŠÙƒÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±.");
    alert("ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø·Ø©");
  }finally{
    addPointBtn.disabled = false;
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù‡Ù…Ø§ ØµØ§Ø±
    safeLoadMap();
  }
});

/* ================= Ask via TEXT ================= */
const sendTextBtn = $("send-text-btn");
sendTextBtn.addEventListener("click", async ()=>{
  const q = $("text-input").value.trim();
  if(!q) return;

  sendTextBtn.disabled = true;
  setBot("ğŸ¤– Ø£ÙÙƒØ±â€¦");
  setStatus("");

  try{
    const fd = new FormData();
    fd.append("query", q);
    fd.append("use_voice", "false");

    const r = await fetch("/llm/voice", { method:"POST", body: fd });
    if(!r.ok) throw new Error(`voice HTTP ${r.status}`);
    const d = await r.json();

    if(d.status === "no_speech"){
      setBot("Ù…Ø§ ÙˆØµÙ„Ù†ÙŠ Ø³Ø¤Ø§Ù„.");
      return;
    }

    setBot(d.response || "ØªÙ…");
    // Ø±Ø¯ ØµÙˆØªÙŠ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
    speak(d.response || "");

  }catch(err){
    console.error(err);
    setBot("âŒ ØµØ§Ø± Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø³Ø¤Ø§Ù„.");
    setStatus("ØªØ£ÙƒØ¯ÙŠ Ø£Ù† /llm/voice Ø´ØºØ§Ù„.");
  }finally{
    sendTextBtn.disabled = false;
  }
});

/* Enter key sends text */
$("text-input").addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    sendTextBtn.click();
  }
});

/* ================= Ask via VOICE ================= */
const micBtn = $("micBtn");
micBtn.addEventListener("click", async ()=>{
  micBtn.disabled = true;
  setBot("ğŸ™ï¸ Ø£Ø³ØªÙ…Ø¹â€¦");
  setStatus("Ù„Ùˆ Ø£ÙˆÙ„ Ù…Ø±Ø©ØŒ ÙØ¹Ù‘Ù„ÙŠ Ø§Ù„ØµÙˆØª Ø¨Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù† Ø²Ø± ğŸ”Š");

  try{
    // Ù‡Ù†Ø§ Ø§Ù„Ø¨Ø§Ùƒ-Ø¥Ù†Ø¯ Ø³ÙŠØ³ØªØ¯Ø¹ÙŠ listen_to_mic
    const fd = new FormData();
    fd.append("use_voice", "false"); // Ù†Ø®Ù„ÙŠÙ‡ false Ù„Ø£Ù†Ù†Ø§ Ø¨Ù†Ù†Ø·Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
    const r = await fetch("/llm/voice", { method:"POST", body: fd });
    if(!r.ok) throw new Error(`voice HTTP ${r.status}`);
    const d = await r.json();

    if(d.status === "no_speech"){
      setBot("Ù…Ø§ Ø§Ù„ØªÙ‚Ø·Øª ØµÙˆØª. Ø¬Ø±Ù‘Ø¨ÙŠ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.");
      return;
    }

    setBot(d.response || "ØªÙ…");
    speak(d.response || "");

  }catch(err){
    console.error(err);
    setBot("âŒ ØµØ§Ø± Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.");
    setStatus("ØªØ£ÙƒØ¯ÙŠ Ø£Ù† /llm/voice Ø´ØºØ§Ù„ ÙˆØ£Ù† Ø§Ù„Ù…Ø§ÙŠÙƒ Ù…Ø¶Ø¨ÙˆØ·.");
  }finally{
    micBtn.disabled = false;
  }
});

/* ================= VLM Image Upload ================= */
const uploadImageBtn = $("upload-image-btn");
const imageInput = $("image-input");

uploadImageBtn?.addEventListener("click", async ()=>{
  const file = imageInput.files[0];
  if(!file){
    alert("Ø§Ø®ØªØ§Ø±ÙŠ ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹");
    return;
  }

  setBot("ğŸ§  Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©â€¦");
  setStatus("");

  try{
    const fd = new FormData();
    fd.append("file", file);

    // Ø¹Ø¯Ù„ÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ø­Ø³Ø¨ Ø³ÙŠØ±ÙØ± Ø§Ù„Ù€ VLM Ø¹Ù†Ø¯Ùƒ
    const r = await fetch("/llm/analyze-image", {
      method: "POST",
      body: fd
    });

    if(!r.ok) throw new Error(`VLM HTTP ${r.status}`);
    const d = await r.json();

    const resultText = d.result || JSON.stringify(d, null, 2);
    setBot(resultText);

    // Ù†Ø·Ù‚ Ø§Ù„Ù†ØªÙŠØ¬Ø© ØµÙˆØªÙŠÙ‹Ø§
    speak(resultText);

  }catch(err){
    console.error(err);
    setBot("âŒ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©.");
    setStatus("ØªØ£ÙƒØ¯ÙŠ Ø£Ù† Ø³ÙŠØ±ÙØ± VLM Ø´ØºØ§Ù„.");
  }
});


</script>

</body>
</html>