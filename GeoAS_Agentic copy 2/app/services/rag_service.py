# rag_service.py
from services.retriever_service import retrievers
from services.llm_service import generate
import re

# ======================================================
# ğŸ§  Prompts
# ======================================================

PROMPT_TEMPLATE = {
    "protected_areas_rules": """ Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ù‚Ø§Ù†ÙˆÙ†ÙŠ ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¹Ø²Ø² (RAG).

Ø§Ù„Ù…Ù‡Ù…Ø©:
Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© ÙˆØ§Ù„ØºØ±Ø§Ù…Ø© ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠ Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹.

Ù‚ÙˆØ§Ø¹Ø¯ Ø¥Ù„Ø²Ø§Ù…ÙŠØ©:
- Ø§Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ø§Ù„Ù†Øµ Ø§Ù„ÙˆØ§Ø±Ø¯ ÙÙŠ Ø§Ù„Ø³ÙŠØ§Ù‚.
- ÙŠÙÙ…Ù†Ø¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙŠ Ù…Ø¹Ø±ÙØ© Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø±Ø¬Ø¹.
- Ù„Ø§ ØªØ®ØªØ±Ø¹ ÙˆÙ„Ø§ ØªÙ‚Ø¯Ù‘Ø± ÙˆÙ„Ø§ ØªØºÙŠÙ‘Ø± Ø£ÙŠ ØºØ±Ø§Ù…Ø© Ø£Ùˆ ØµÙŠØ§ØºØ©.
- Ù„Ø§ ØªØ¯Ù…Ø¬ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø®Ø§Ù„ÙØ©.
- Ø£Ø¬Ø¨ ÙÙ‚Ø· Ø¨Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯.
- Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ© Ù…Ø·Ø§Ø¨Ù‚Ø©ØŒ Ø§ÙƒØªØ¨ ÙÙ‚Ø·:
  "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ© Ù…Ø·Ø§Ø¨Ù‚Ø© ÙÙŠ Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù…ØªØ§Ø­."

ØµÙŠØºØ© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ø¥Ù„Ø²Ø§Ù…ÙŠØ©):

Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©: (ÙƒÙ…Ø§ ÙˆØ±Ø¯Øª ÙÙŠ Ø§Ù„Ù…Ø±Ø¬Ø¹)
Ø§Ù„ØºØ±Ø§Ù…Ø©: (ÙƒÙ…Ø§ ÙˆØ±Ø¯Øª ÙÙŠ Ø§Ù„Ù…Ø±Ø¬Ø¹)
Ø¹Ù‚ÙˆØ¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ø­ØªÙ…Ù„Ø©: (Ø¥Ù† ÙˆÙØ¬Ø¯Øª)

---

Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹:
{context}

Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:
{question}

Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:
""",

    "Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù„Ø§Ø¦Ø­Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ© Ù„Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø­Ù…ÙŠØ©": """ Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¹Ø²Ø² (RAG) Ù„ØªÙ‚Ø¯ÙŠÙ… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø© Ø¹Ù† Ø§Ù„Ù…Ø­Ù…ÙŠØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©.

Ø§Ø¹ØªÙ…Ø¯ Ø¨Ø´ÙƒÙ„ Ø£Ø³Ø§Ø³ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹ ÙÙŠ Ø§Ù„Ø³ÙŠØ§Ù‚ØŒ 
ÙˆÙŠÙØ³Ù…Ø­ Ù„Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø±ÙØªÙƒ Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‹Ø§ Ù…Ø­Ø¯ÙˆØ¯Ù‹Ø§ ÙÙ‚Ø· Ù…Ù† Ø£Ø¬Ù„:
- ØªØ¨Ø³ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø©
- Ø¥Ø¹Ø§Ø¯Ø© ØµÙŠØ§ØºØªÙ‡Ø§ Ø¨Ø´ÙƒÙ„ Ø£ÙˆØ¶Ø­
- Ø±Ø¨Ø· Ø§Ù„Ø¬Ù…Ù„Ø© Ù„ØºÙˆÙŠÙ‹Ø§

Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ù‡Ù…Ø©:
1. Ù„Ø§ ØªØ¶Ù Ø­Ù‚Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ§Ù‚.
2. Ù„Ø§ ØªØ°ÙƒØ± Ø£Ø±Ù‚Ø§Ù…Ù‹Ø§ Ø£Ùˆ ØªÙØ§ØµÙŠÙ„ Ø±Ø³Ù…ÙŠØ© ØºÙŠØ± Ù…Ø°ÙƒÙˆØ±Ø©.
3. Ù„Ø§ ØªØ°ÙƒØ± Ù‚ÙˆØ§Ù†ÙŠÙ† Ø£Ùˆ ØºØ±Ø§Ù…Ø§Øª Ø£Ùˆ Ø¹Ù‚ÙˆØ¨Ø§Øª.
4. Ù„Ø§ ØªÙ‚Ø¯Ù‘Ù… Ø§Ø³ØªÙ†ØªØ§Ø¬Ø§Øª Ø¹Ù„Ù…ÙŠØ© Ø£Ùˆ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨ÙŠØ¦ÙŠØ©.
5. Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙˆÙØ± Ø¬ÙˆØ§Ø¨ ÙˆØ§Ø¶Ø­ ÙÙŠ Ø§Ù„Ø³ÙŠØ§Ù‚ØŒ Ù‚Ù„:
   "Ù„Ø§ ØªØªÙˆÙØ± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙƒØ§ÙÙŠØ© Ø­ÙˆÙ„ Ø°Ù„Ùƒ ÙÙŠ Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…ØªØ§Ø­."

---

Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹:
{context}

Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:
{question}

Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:
"""
}

# ğŸ”¹ Ø¨Ø±ÙˆÙ…Ø¨Øª Ø®Ø§Øµ Ø¨Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø­ÙƒÙ… (Ù…Ø³Ù…ÙˆØ­ / ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­)
PERMISSION_PROMPT = """Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ù‚Ø§Ù†ÙˆÙ†ÙŠ ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¹Ø²Ø² (RAG).

Ù…Ù‡Ù…ØªÙƒ:
- ØªØ­Ù‚Ù‘Ù‚ ÙÙ‚Ø· Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø®Ø§Ù„ÙØ© ØªØ®Øµ Ø§Ù„ÙØ¹Ù„ Ø§Ù„Ù…Ø°ÙƒÙˆØ± ÙÙŠ Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¶Ù…Ù† Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹.
- Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª Ù…Ø®Ø§Ù„ÙØ© ØªØ®Øµ Ù‡Ø°Ø§ Ø§Ù„ÙØ¹Ù„ØŒ ÙØ§Ù„Ù†ØªÙŠØ¬Ø©:
  "ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­".
- Ø¥Ø°Ø§ Ù„Ù… ØªÙØ°ÙƒØ± Ø£ÙŠ Ù…Ø®Ø§Ù„ÙØ© ØªØ®Øµ Ù‡Ø°Ø§ Ø§Ù„ÙØ¹Ù„ØŒ Ø§ÙƒØªØ¨ ÙÙ‚Ø·:
  "Ù„Ø§ ØªØªÙˆÙØ± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙƒØ§ÙÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù…ØªØ§Ø­."
- Ù„Ø§ ØªØ°ÙƒØ± Ø§Ù„ØºØ±Ø§Ù…Ø© Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø·ÙÙ„Ø¨Øª ØµØ±Ø§Ø­Ø© ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„.
- Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø£ÙŠ Ù…Ø¹Ø±ÙØ© Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Øµ.

---

Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹:
{context}

Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:
{question}

Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:
"""

# ======================================================
# ğŸ§  Helpers
# ======================================================

def detect_intent(query: str) -> str:
    q = query.strip()

    # Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø­ÙƒÙ…
    if any(word in q for word in [
        "Ù‡Ù„", "Ù…Ø³Ù…ÙˆØ­", "Ù…Ù…Ù†ÙˆØ¹", "ÙŠØ¬ÙˆØ²", "ÙŠØ³Ù…Ø­", "Ø£Ù‚Ø¯Ø±"
    ]):
        return "permission"

    # Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØºØ±Ø§Ù…Ø©
    if any(word in q for word in [
        "ØºØ±Ø§Ù…Ø©", "ØºØ±Ø§Ù…ØªÙ‡Ø§", "Ø¹Ù‚ÙˆØ¨Ø©", "ÙƒÙ…", "Ù‚ÙŠÙ…Ø©"
    ]):
        return "penalty"

    return "general"


def _normalize_key(name: str) -> str:
    if not name:
        return ""
    name = name.strip()
    if name.lower().endswith(".pdf"):
        name = name[:-4]
    return name


def _clean_text_for_rules(text: str) -> str:
    if not text:
        return ""
    text = text.replace("\r\n", "\n").replace("\r", "\n")
    text = re.sub(r"[ \t]+", " ", text)
    text = re.sub(r"\n{3,}", "\n\n", text)
    return text.strip()


def _clean_text_general(text: str) -> str:
    if not text:
        return ""
    return re.sub(r"\s+", " ", text).strip()

# ======================================================
# ğŸ¯ Main RAG Answer Function
# ======================================================

def answer(query: str, pdf_name: str):
    pdf_name = _normalize_key(pdf_name)

    retriever = retrievers.get(pdf_name)
    if not retriever:
        return "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨Ø­Ø« ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ø­Ø§Ù„ÙŠØ§Ù‹.", ""

    # ğŸ§  ØªØ­Ø¯ÙŠØ¯ Ù†ÙŠØ© Ø§Ù„Ø³Ø¤Ø§Ù„
    intent = detect_intent(query)

    # ğŸ” Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹
    docs = retriever.invoke(query)

    formatted_contexts = []
    for i, doc in enumerate(docs):
        text = doc.page_content or ""
        clean = (
            _clean_text_for_rules(text)
            if pdf_name == "protected_areas_rules"
            else _clean_text_general(text)
        )
        formatted_contexts.append(f"--- [Ø§Ù„ÙÙ‚Ø±Ø© {i+1}] ---\n{clean}")

    context = "\n\n".join(formatted_contexts).strip()

    if not context:
        return "Ù„Ø§ ØªØªÙˆÙØ± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙƒØ§ÙÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù…ØªØ§Ø­.", ""

    # ğŸŸ¢ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙŠØ©
    if intent == "permission":
        final_prompt = PERMISSION_PROMPT.format(
            context=context,
            question=query
        )
    else:
        prompt_template = PROMPT_TEMPLATE.get(pdf_name)
        if not prompt_template:
            return "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙˆÙ…Ø¨Øª Ù…Ø®ØµØµ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙ†Ø¯.", context

        final_prompt = prompt_template.format(
            context=context,
            question=query
        )

    # ğŸ¤– ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
    response = generate(final_prompt) or ""

    # ğŸ”’ Ø­Ù…Ø§ÙŠØ©: ØºØ±Ø§Ù…Ø© Ø¨Ø¯ÙˆÙ† Ù…Ø®Ø§Ù„ÙØ© = Ø±ÙØ¶
    if intent != "permission":
        if "Ø§Ù„ØºØ±Ø§Ù…Ø©" in response and "Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©" not in response:
            return "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ© Ù…Ø·Ø§Ø¨Ù‚Ø© ÙÙŠ Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù…ØªØ§Ø­.", context

    return response.strip(), context