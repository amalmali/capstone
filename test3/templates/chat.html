<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ø§Ù„Ø°ÙƒÙŠ | Ø§Ù„ÙƒØ´Ùƒ Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        :root {
            --primary-bg: #0f172a;
            --card-bg: #1e293b;
            --accent-blue: #38bdf8;
            --accent-red: #ef4444;
            --accent-green: #22c55e;
            --accent-purple: #8b5cf6;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
        }

        body {
            margin: 0;
            background: var(--primary-bg);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden;
        }

        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 1.8rem; color: var(--accent-blue); }
        .header p { color: var(--text-dim); margin-top: 5px; }
        
        /* Ù…Ø­ÙˆÙ„ Ø§Ù„Ø£Ù†Ù…Ø§Ø· */
        .mode-selector {
            display: flex; gap: 10px; margin-bottom: 25px;
            background: var(--card-bg); padding: 8px; border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .mode-btn {
            padding: 10px 20px; border-radius: 40px; border: none;
            cursor: pointer; background: transparent; color: var(--text-dim);
            font-weight: bold; transition: 0.3s;
        }

        .mode-btn.active {
            background: var(--accent-blue); color: white;
            box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3);
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„ */
        .interaction-container {
            width: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; margin-bottom: 20px;
        }

        #voice-section { display: flex; flex-direction: column; align-items: center; }
        .circle-btn {
            width: 150px; height: 150px; border-radius: 50%;
            border: none; background: var(--accent-blue); color: white;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; gap: 8px; user-select: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        
        .circle-btn.listening { 
            background: var(--accent-red) !important; 
            box-shadow: 0 0 40px rgba(239,68,68,0.6); 
            transform: scale(1.1); 
        }
        
        .circle-btn.thinking { 
            background: var(--accent-purple) !important; 
            animation: breathe 1.5s infinite; 
        }

        #text-section { 
            display: none; width: 100%; max-width: 600px;
            background: var(--card-bg); padding: 15px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
        #output-area { width: 100%; max-width: 800px; flex: 1; overflow-y: auto; padding-bottom: 100px; }
        .chat-card {
            background: var(--card-bg); padding: 25px; border-radius: 20px;
            border-right: 5px solid var(--accent-blue);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s ease;
        }
        #user-q { color: var(--accent-blue); font-size: 0.9rem; margin-bottom: 10px; font-weight: bold; border-bottom: 1px solid #334155; padding-bottom: 5px; display: none; }
        #bot-p { line-height: 1.8; font-size: 1.1rem; }

        /* Ø´Ø±ÙŠØ· GPS Ø§Ù„Ù…ÙˆØ­Ø¯ */
        #gps-alert-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 18px; text-align: center; font-weight: bold;
            background: #334155; color: white;
            transition: background 0.8s ease; z-index: 1000;
            display: flex; align-items: center; justify-content: center; gap: 12px;
            font-size: 1.1rem; box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
        }

        @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.08); opacity: 0.7; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="header">
        <h1>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h1>
        <p id="status-text">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙˆØ§Ø³Ø£Ù„ Ø¹Ù† Ø£ÙŠ Ù„Ø§Ø¦Ø­Ø© Ø¨ÙŠØ¦ÙŠØ©</p>
    </div>

    <div class="mode-selector">
        <button id="btn-mode-voice" class="mode-btn active" onclick="switchMode('voice')">ğŸ¤ Ù†Ù…Ø· Ø§Ù„ØªØ­Ø¯Ø«</button>
        <button id="btn-mode-text" class="mode-btn" onclick="switchMode('text')">âŒ¨ï¸ Ù†Ù…Ø· Ø§Ù„ÙƒØªØ§Ø¨Ø©</button>
    </div>

    <div class="interaction-container">
        <div id="voice-section">
            <button id="action-btn" class="circle-btn" onmousedown="startVoice()" onmouseup="stopVoice()">
                <span id="mic-icon" style="font-size: 3rem;">ğŸ¤</span>
                <span id="btn-text">ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†</span>
            </button>
        </div>

        <div id="text-section">
            <div style="display: flex; gap: 10px;">
                <input type="text" id="text-input" style="flex:1; padding:12px; border-radius:12px; border:none; background:#0f172a; color:white;" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§...">
                <button onclick="sendTextQuery()" style="padding:10px 20px; border-radius:12px; border:none; background:var(--accent-blue); color:white; font-weight:bold;">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <div id="output-area">
        <div class="chat-card">
            <div id="user-q">Ø³Ø¤Ø§Ù„Ùƒ: <span id="user-text"></span></div>
            <div id="bot-p">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø°ÙƒÙŠ. Ø£Ù†Ø§ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ø³ØªÙØ³Ø§Ø±Ø§ØªÙƒ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆØ§Ù„Ø¨ÙŠØ¦ÙŠØ©.</div>
        </div>
    </div>

    <div id="gps-alert-bar">
        <span id="gps-status-icon">ğŸ“¡</span>
        <span id="gps-status-text">Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø¹ Ù†Ø¸Ø§Ù… GPS...</span>
    </div>

    <script>
        let isRecording = false;

        // 1. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù€ GPS Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…ÙˆØ­Ø¯
        async function fetchGPS() {
            try {
                const response = await fetch('/llm/gps-status');
                const data = await response.json();
                const bar = document.getElementById('gps-alert-bar');
                const text = document.getElementById('gps-status-text');
                const icon = document.getElementById('gps-status-icon');

                if (data.status === 'success') {
                    text.innerText = data.message;
                    if (data.is_inside) {
                        bar.style.backgroundColor = "var(--accent-green)";
                        icon.innerText = "âœ…";
                    } else {
                        bar.style.backgroundColor = "var(--accent-red)";
                        icon.innerText = "âš ï¸";
                    }
                }
            } catch (e) { console.log("GPS Sync Wait..."); }
        }

        // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 3 Ø«ÙˆØ§Ù†Ù Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ©
        setInterval(fetchGPS, 3000);

        // 2. Ø¥Ø¯Ø§Ø±Ø© Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        function switchMode(mode) {
            document.getElementById('voice-section').style.display = (mode === 'voice') ? 'flex' : 'none';
            document.getElementById('text-section').style.display = (mode === 'text') ? 'block' : 'none';
            document.getElementById('btn-mode-voice').classList.toggle('active', mode === 'voice');
            document.getElementById('btn-mode-text').classList.toggle('active', mode === 'text');
        }

        // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØª
        function startVoice() {
            isRecording = true;
            const btn = document.getElementById('action-btn');
            btn.classList.add('listening');
            document.getElementById('btn-text').innerText = "Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ­Ø¯Ø«";
        }

        function stopVoice() {
            if (!isRecording) return;
            isRecording = false;
            processRequest(null);
        }

        function sendTextQuery() {
            const q = document.getElementById('text-input').value;
            if (q.trim()) processRequest(q);
        }

        // 4. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³ÙŠØ±ÙØ± (FastAPI)
        async function processRequest(query) {
            const btn = document.getElementById('action-btn');
            const statusText = document.getElementById('status-text');
            const botP = document.getElementById('bot-p');
            const userQ = document.getElementById('user-q');
            
            btn.classList.remove('listening');
            btn.classList.add('thinking');
            btn.disabled = true;
            statusText.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ...";

            const formData = new FormData();
            if (query) formData.append('query', query);
            formData.append('use_voice', 'true');

            try {
                const resp = await fetch('/llm/voice-interaction', { method: 'POST', body: formData });
                const data = await resp.json();

                if (data.status === 'success') {
                    userQ.style.display = "block";
                    document.getElementById('user-text').innerText = data.query;
                    botP.innerText = data.response;
                    statusText.innerText = "ØªÙ…Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©";
                } else {
                    botP.innerText = data.message;
                    statusText.innerText = "Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰";
                }
            } catch (err) {
                botP.innerText = "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ.";
            } finally {
                btn.classList.remove('thinking');
                btn.disabled = false;
                document.getElementById('btn-text').innerText = "ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†";
            }
        }
    </script>
</body>
</html>